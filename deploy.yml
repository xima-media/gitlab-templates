# Usage: This template is intended to be included in other GitLab CI/CD configuration files.
# It defines post-development deployment and reset jobs that can be used in a CI/CD pipeline.

# Integration example in importing gitlab-ci.yml:
#
# include:
#   - remote: 'https://raw.githubusercontent.com/xima-media/gitlab-templates/refs/heads/deployment_jobs/deploy.yml'
#     inputs:
#       ci_server_url: https://gitlab.com/
#       test_environment_url: https://test.example.org
#       live_environment_url: https://www.example.org/

spec:
  inputs:
    ci_server_url:
      type: string
      description: "URL of the CI server for post development deployments."
    # deployment job variables
    test_host_branch:
      type: string
      default: $TEST_HOST_BRANCH
      description: "Branch to deploy to test environment."
    test_instance:
      type: string
      default: "stage=test"
      description: "Instance name for test deployment job."
      regex: ^[a-zA-Z0-9_=]+$
    test_environment_url:
      type: string
      description: "URL of the test environment."
    live_instance:
      type: string
      default: "stage=live"
      description: "Instance name for live deployment job."
      regex: ^[a-zA-Z0-9_=]+$
    live_environment_url:
      type: string
      description: "URL of the live environment."
    # release job variables
    release_ref:
      type: string
      default: $CI_COMMIT_SHA
      description: "Git reference for the release job. Defaults to the commit SHA."
    release_tag_name:
      type: string
      description: "Tag name for the release job. Semver format required, e.g. 'v1.0.${CI_PIPELINE_IID}'"
    release_description:
      type: string
      description: "Description for the release job."
    # reset job variables
    reset_sync_dirs:
      type: string
      default: "fileadmin uploads"
      description: "Space separated list of directories in shared/public/ to sync from source to target environment."
      regex: ^[a-zA-Z0-9_. -]+$
    reset_max_size:
      type: string
      default: "5M"
      description: "Maximum file size to sync from source to target environment, e.g. 5M or 1G."
      regex: ^[0-9]+[KMG]$

---

# Deployment jobs
deploy-test:
  environment:
    name: TEST
    url: $[[ inputs.test_environment_url ]]
    deployment_tier: testing
  stage: deploy.postdev
  extends: .deploy-prepare
  dependencies:
    - build-php
    - build-node
  rules:
    - if: '$CI_SERVER_URL != "$[[ inputs.ci_server_url | expand_vars ]]"'
      when: never
    - if: $RESET_JOB == "true"
      when: never
    - if: '$CI_COMMIT_BRANCH == "$[[ inputs.test_host_branch | expand_vars ]]"'
  script:
    - vendor/bin/dep deploy:unlock $[[ inputs.test_instance ]] --branch=$CI_COMMIT_BRANCH -vvv
    - vendor/bin/dep deploy-fast $[[ inputs.test_instance ]] --branch=$CI_COMMIT_BRANCH -vvv

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  dependencies: []
  rules:
    - if: $RESET_JOB == "true"
      when: never
    - if: $CI_COMMIT_BRANCH == "main" && $CI_SERVER_URL == $XIMA_CI_SERVER_URL
  script:
    - 'echo "Creating release $[[ inputs.release_tag_name ]] for ref $[[ inputs.release_ref ]]"'
  release:
    tag_name: $[[ inputs.release_tag_name ]]
    description: $[[ inputs.release_description ]]
    ref: $[[ inputs.release_ref ]]

deploy-live:
  environment:
    name: LIVE
    url: $[[ inputs.live_environment_url ]]
    deployment_tier: production
  stage: deploy.postdev
  extends: .deploy-prepare
  dependencies:
    - build-php
    - build-node
  rules:
    - if: '$CI_SERVER_URL != "$[[ inputs.ci_server_url | expand_vars ]]"'
      when: never
    - if: $RESET_JOB == "true"
      when: never
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/
  script:
    - vendor/bin/dep deploy:unlock $[[ inputs.live_instance ]]
    - vendor/bin/dep deploy $[[ inputs.live_instance ]] -vvv

deploy-live-warmup:
  needs:
    - job: build-php
    - job: deploy-live
  stage: deploy.postdev
  extends: .deploy-prepare
  rules:
    - if: '$CI_SERVER_URL != "$[[ inputs.ci_server_url | expand_vars ]]"'
      when: never
    - if: $RESET_JOB == "true"
      when: never
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/
  script:
    - vendor/bin/dep deploy:cache:warmup $[[ inputs.live_instance ]] -vvv


# Reset jobs

reset-upload:
  needs:
    - job: build-php
  stage: build
  extends: .deploy-prepare
  variables:
  script:
    # ensure RCLONE_RESET_STORAGE_ENV and RCLONE_RESET_CRYPT_ENV file variables are set
    - 'if [ ! -f "${RCLONE_RESET_STORAGE_ENV}" ] || [ ! -f "${RCLONE_RESET_CRYPT_ENV}" ]; then echo "RCLONE_RESET_STORAGE_ENV and RCLONE_RESET_CRYPT_ENV must be set as CI/CD file variables!"; exit 1; fi'
    # install rclone and jq
    - apk add --update --quiet rclone jq && rclone version && jq --version
    # create rclone sftp remote for source from deploy.php
    - SFTP_HOST=$(vendor/bin/dep config --format json $[[ inputs.live_instance ]] | jq -r '.[].hostname')
    - SFTP_USER=$(vendor/bin/dep config --format json $[[ inputs.live_instance ]] | jq -r '.[].remote_user')
    - DEPLOY_PATH=$(vendor/bin/dep config --format json $[[ inputs.live_instance ]] | jq -r '.[].deploy_path')
    - rclone config create --non-interactive sftp sftp host=${SFTP_HOST} user=${SFTP_USER} port=22 key_use_agent=true
    # create crypt remote for upload
    - set -a && . ${RCLONE_RESET_STORAGE_ENV} && . ${RCLONE_RESET_CRYPT_ENV} && set +a
    - 'rclone config create --non-interactive --obscure ${CRYPT_NAME} crypt remote=storage:${CRYPT_DIR}/${CRYPT_NAME} filename_encoding=base64 password=${CRYPT_PASSWORD} password2=${CRYPT_PASSWORD2}'
    # dump database on source
    - vendor/bin/dep db:rmdump "$[[ inputs.live_instance ]]" --options=dumpcode:resetJob --no-interaction -vvv
    - vendor/bin/dep db:export "$[[ inputs.live_instance ]]" --options=dumpcode:resetJob --no-interaction -vvv
    - vendor/bin/dep db:process "$[[ inputs.live_instance ]]" --options=dumpcode:resetJob --no-interaction -vvv
    - vendor/bin/dep db:compress "$[[ inputs.live_instance ]]" --options=dumpcode:resetJob --no-interaction -vvv
    # sync database from sftp remote to crypt remote
    - 'rclone sync -v --inplace --metadata "sftp:${DEPLOY_PATH}/.dep/database/" ${CRYPT_NAME}:.dep/database'
    # sync media files from sftp to crypt remote with applied filters
    - |
      for dir in $[[ inputs.reset_sync_dirs ]]; do
        rclone sync -v --inplace --metadata --size-only "sftp:${DEPLOY_PATH}/shared/public/${dir}/" "${CRYPT_NAME}:shared/public/${dir}/" \
          --max-size "$[[ inputs.reset_max_size ]]" \
          --delete-excluded \
          --exclude "_processed_/**" \
          --exclude "_recycler_/**" \
          --exclude "_temp_/**" \
          --exclude "*.mp4" \
          --exclude "*.zip" \
          --exclude "*.pdf" \
          --exclude "*.exe" \
          --exclude "*.doc" \
          --exclude "*.docx" \
          --exclude "*.pptx" \
          --exclude "*.ppt" \
          --exclude "*.xls" \
          --exclude "*.xlsx" \
          --exclude "*.xlsm" \
          --exclude "*.tiff" \
          --exclude "*.tif" \
          --exclude "*.potx" \
          --exclude "*.mpg" \
          --exclude "*.mp3" \
          --exclude "*.avi" \
          --exclude "*.wmv" \
          --exclude "*.flv" \
          --exclude "*.eps" \
          --exclude "*.ai" \
          --exclude "*.mov"
      done
  rules:
    - if: '$CI_SERVER_URL != "$[[ inputs.ci_server_url | expand_vars ]]"'
      when: never
    - if: $RESET_JOB == "true"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

reset-test:
  needs:
    - job: build-php
    - job: reset-upload
  stage: build
  extends: .deploy-prepare
  script:
    # ensure RCLONE_RESET_STORAGE_ENV and RCLONE_RESET_CRYPT_ENV file variables are set
    - 'if [ ! -f "${RCLONE_RESET_STORAGE_ENV}" ] || [ ! -f "${RCLONE_RESET_CRYPT_ENV}" ]; then echo "RCLONE_RESET_STORAGE_ENV and RCLONE_RESET_CRYPT_ENV must be set as CI/CD file variables!"; exit 1; fi'
    # install rclone and jq
    - apk add --update --quiet rclone jq && rclone version && jq --version
    # create rclone sftp remote for target from deploy.php
    - SFTP_HOST=$(vendor/bin/dep config --format json $[[ inputs.test_instance ]] | jq -r '.[].hostname')
    - SFTP_USER=$(vendor/bin/dep config --format json $[[ inputs.test_instance ]] | jq -r '.[].remote_user')
    - DEPLOY_PATH=$(vendor/bin/dep config --format json $[[ inputs.test_instance ]] | jq -r '.[].deploy_path')
    - rclone config create --non-interactive sftp sftp host=${SFTP_HOST} user=${SFTP_USER} port=22 key_use_agent=true
    # create crypt remote for download
    - apk add --update --quiet rclone jq && rclone version && jq --version
    - set -a && . ${RCLONE_RESET_STORAGE_ENV} && . ${RCLONE_RESET_CRYPT_ENV} && set +a
    - 'rclone config create --non-interactive --obscure ${CRYPT_NAME} crypt remote=storage:${CRYPT_DIR}/${CRYPT_NAME} filename_encoding=base64 password=${CRYPT_PASSWORD} password2=${CRYPT_PASSWORD2}'
    # remove old dump on target
    - vendor/bin/dep db:rmdump "$[[ inputs.test_instance ]]" --options=dumpcode:resetJob --no-interaction -vvv
    # copy database from crypt remote to sftp remote
    - 'rclone copy -v --inplace --metadata "${CRYPT_NAME}:.dep/database/" "sftp:${DEPLOY_PATH}/.dep/database/"'
    # import database on target
    - vendor/bin/dep db:decompress "$[[ inputs.test_instance ]]" --options=dumpcode:resetJob --no-interaction -vvv
    - vendor/bin/dep db:process "$[[ inputs.test_instance ]]" --options=dumpcode:resetJob --no-interaction -vvv
    - vendor/bin/dep db:import "$[[ inputs.test_instance ]]" --options=dumpcode:resetJob --no-interaction -vvv
    - vendor/bin/dep db:rmdump "$[[ inputs.test_instance ]]" --options=dumpcode:resetJob --no-interaction -vvv
    # copy media files from crypt remote to sftp remote and fix file permissions
    - |
      for dir in $[[ inputs.reset_sync_dirs ]]; do
        rclone copy -v --inplace --metadata --no-update-modtime --no-update-dir-modtime --sftp-set-modtime=false --size-only "${CRYPT_NAME}:shared/public/${dir}/" "sftp:${DEPLOY_PATH}/shared/public/${dir}/"
        vendor/bin/dep run "find public/${dir}/ -type f ! -perm 660 -user ${SFTP_USER} -exec chmod 660 {} \;" "$[[ inputs.test_instance ]]" --no-interaction -vvv
      done
  rules:
    - if: '$CI_SERVER_URL != "$[[ inputs.ci_server_url | expand_vars ]]"'
      when: never
    - if: $RESET_JOB == "true"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
